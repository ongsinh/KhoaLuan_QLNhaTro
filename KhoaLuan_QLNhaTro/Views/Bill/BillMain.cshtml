@model List<KhoaLuan_QLNhaTro.Models.BillViewModal>
@{
    var rooms = ViewBag.Rooms as List<KhoaLuan_QLNhaTro.Models.Room>;  // Lấy danh sách phòng từ ViewBag
}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Billing Management</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="~/css/BillMain.css" />
</head>
<body>

    <!-- Header Section -->
    <div class="header">
        <h2>Tất cả hóa đơn - 10/2024</h2>
        <div class="navigation">
            <button>◀ Năm trước</button>
            <button>Năm tới ▶</button>
            <select>
                <option>T.1 2024</option>
                <option>T.2 2024</option>
                <option>T.3 2024</option>
                <option>T.4 2024</option>
                <option selected>T.10 2024</option>
            </select>
        </div>
    </div>

    <!-- Filter Section -->
    <div class="filters">
        <div class="filter-item">
            <input type="checkbox" id="paid" />
            <label for="paid">Hóa đơn đã thu</label>
        </div>
        <div class="filter-item">
            <input type="checkbox" id="unpaid" />
            <label for="unpaid">Hóa đơn chưa thu</label>
        </div>
        <div class="filter-item">
            <input type="checkbox" id="pending" />
            <label for="pending">Hóa đơn đang nợ</label>
        </div>
    </div>

    <!-- Action Buttons -->
    <div class="actions">
        <button class="add-button-bill" data-toggle="modal" data-target="#billingModal">+</button>
        <button>In hóa đơn</button>
    </div>

    <!-- Table Section -->
    <table>
        <thead>
            <tr>
                <th>Tên phòng</th>
                <th>Tiền phòng</th>
                @foreach (var service in ViewBag.Services)
                {
                    <th>@service.Name</th> <!-- Tên dịch vụ được thêm làm cột -->
                }
                <th>Tổng cộng</th>
                <th>Trạng thái</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
@*             <!-- Group Row -->
            <tr class="group-header">
                <td colspan="11">Tầng trệt (1 hóa đơn)</td>
            </tr>
 *@
            <!-- Invoice Row -->
            @foreach (var bill in Model)
            {
                <tr>
                    <td>@bill.RoomName</td>
                    <td>@bill.RoomPrice</td>
                    @foreach (var service in bill.Services)
                    {
                        var matchingService = bill.Services.FirstOrDefault(s => s.ServiceName == service.ServiceName);
                        <td>
                            @((matchingService != null) ? matchingService.TotalPrice : 0) <!-- Hiển thị giá trị 0 nếu không có dịch vụ -->
                        </td>
                    }
                    <td>@bill.TotalBill</td>
                    <td><span class="badge unpaid">@bill.Status</span></td>
                    <td>
                        <div class="action-menu">
                            <i class="fas fa-ellipsis-v" onclick="showInvoiceEditModal()"></i>
                        </div>
                    </td>
                    <td>
                        <button class="btn btn-primary" onclick="payBill('@bill.BillId', '@bill.TotalBill','@bill.RoomName')">Thanh toán</button>
                    </td>
                </tr>
            }
        </tbody>
    </table>

    @* Bước 1 lập chọn phòng để chốt hóa đơn *@
    <div class="modal fade" id="billingModal">    
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <!-- Modal Header -->
                <div class="modal-header">
                    <h5 class="modal-title">Lập hóa đơn nhiều phòng (Lập hóa đơn nhanh)</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>

                <div class="modal-body">
                    <div class="step-indicator">Bước 1: Chốt dịch vụ</div>
                    <div class="row">
                        <!-- Danh sách các phòng -->
                        <div class="col-md-8 mb-6 room-list">
                            <div class="row">
                                @foreach(var room in rooms)
                                {
                                    <div class="col-md-6 mb-3">
                                        <div class="card p-3">
                                            <div class="room-status badge badge-contract-ending mb-2">@room.Status</div>
                                            <h6>@room.Name</h6>
                                            <p>@room.Price</p>
                                            <button class="btn btn-close-service btn-block room-item" data-room-id="@room.Id" >Chốt</button>
                                        </div>
                                    </div>
                                }
                                <!-- Thêm các thẻ phòng khác ở đây -->
                            </div>
                        </div>

                        <!-- Dịch vụ cần chốt -->
                        <div class="col-md-4 mb-3 service-details">
                            <div id="service-details" class="service-details-modal" style="display: none;">
                                <h5>Dịch vụ của phòng: <span id="selected-room-name"></span></h5>
                                <div class="input-group">
                                    <input type="date" class="form-control settlementdate" name="SettlementdDate" placeholder="Ngày chốt">
                                    <span class="input-group-text">Ngày chốt</span>
                                </div>
                                <div id="services"></div>
                            </div>
                        </div>
                    </div>
                </div>


                <!-- Khu vực Thông báo -->
                <div class="alert alert-success alert-custom mt-3" role="alert">
                    0 phòng đã được chốt dịch vụ và sẵn sàng lập hóa đơn
                </div>
                <!-- Modal Footer -->
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Đóng</button>
                    <button type="button" class="btn btn-success goToStep2" data-toggle="modal" data-target="#createInvoiceModal" data-dismiss="modal">Bước 2: Lập hóa đơn</button>
                </div>
            </div>
        </div>
    </div>
    </div>


    <!-- Modal bước 2 sau khi chốt phòng -->
    <div class="modal fade" id="createInvoiceModal" tabindex="-1" aria-labelledby="createInvoiceModalLabel" >
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="createInvoiceModalLabel">Lập hóa đơn nhiều phòng (Lập hóa đơn nhanh)</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    @* <div id="services-data" style="border: 1px solid #000; padding: 10px; margin-top: 20px;">
                        <h3>Dữ liệu dịch vụ:</h3>
                        <pre id="services-output"></pre>
                    </div> *@

                    <!-- Step Indicator -->
                    <div class="d-flex justify-content-between mb-3">
                        <span class="badge bg-secondary">Bước 1: Chốt dịch vụ</span>
                        <span class="badge bg-success">Bước 2: Lập hóa đơn</span>
                    </div>

                    <!-- Form Content -->
                    <div class="alert alert-success">
                        <strong>Đã chốt 1 phòng</strong><br>
                        Nhập các thông tin bên phải để thực hiện tạo hóa đơn!
                    </div>

                    <form id="invoiceForm" asp-action="CreateInvoice" asp-controller="Bill" method="post">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="month" class="form-label">Tháng lập phiếu*</label>
                                <input type="text" class="form-control" id="month" name="month" value="11/2024" readonly>
                            </div>

                            <div class="col-md-6 mb-3">
                                <label for="CreateAt" class="form-label">Ngày lập hóa đơn*</label>
                                <input type="date" class="form-control" id="CreateAt" name="CreateAt" value="2024-11-01">
                            </div>

                            <div class="col-md-6 mb-3">
                                <label for="reason" class="form-label">Lý do thu tiền*</label>
                                <select class="form-select" id="reason" name="reason">
                                    <option value="Thu tiền hàng tháng">Thu tiền hàng tháng</option>
                                    <!-- Add other options if needed -->
                                </select>
                            </div>

                            <div class="col-md-6 mb-3">
                                <label for="PaymentDate" class="form-label">Hạn đóng tiền*</label>
                                <input type="date" class="form-control" id="PaymentDate" name="PaymentDate" value="2024-12-01">
                            </div>
                            <div style="display: none;">
                                <input type="hidden" id="RoomId" name="RoomId" value="">
                            </div>
                            <div class="col-md-6 mb-3">
                                <input type="date" id="SettlementDate" name="SettlementDate" value="">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label>Danh sách dịch vụ</label>
                                <input  id="ServicesData" name="ServicesData" value="">
                            </div>
                            

                        </div>

                        <!-- Additional Information -->
                        <div class="alert alert-info mt-3">
                            Thông tin: Các phòng/giường lập hóa đơn mặc định tính tròn 1 tháng
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Đóng</button>
                    <button type="button" class="btn btn-success back_add_bill" data-toggle="modal" data-target="#billingModal">Bước 1: Chốt dịch vụ </button>
                    <button type="submit" form="invoiceForm" class="btn btn-success">Lập hóa đơn</button>
                </div>
            </div>
        </div>
    </div>

    @* chỉnh sửa hóa đơn *@
    <!-- Popup Modal -->
    <div id="invoiceEditModal" class="modal fade invoice-edit-modal" tabindex="-1" role="dialog" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <!-- Modal Header -->
                <div class="modal-header">
                    <h5 class="modal-title">Chỉnh sửa hóa đơn cho "Phòng 2"</h5>
                    <button type="button" class="close" onclick="closeInvoiceEditModal()" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>

                <!-- Modal Body -->
                <div class="modal-body">
                    <!-- Thông tin lập phiếu -->
                    <div class="form-group">
                        <label>Tháng lập phiếu</label>
                        <input type="text" class="form-control" value="11/2024" readonly>
                    </div>
                    <div class="form-group">
                        <label>Ngày lập hóa đơn</label>
                        <input type="date" class="form-control" value="2024-11-03">
                    </div>
                    <div class="form-group">
                        <label>Hạn đóng tiền</label>
                        <input type="date" class="form-control" value="2024-12-04">
                    </div>

                    <!-- Thu tiền hàng tháng -->
                    <div class="billing-section mt-4">
                        <h6>Thu tiền hàng tháng</h6>
                        <p>Ngày vào: 10/09/2024</p>
                        <p>Chu kỳ thu: <b>1 tháng, 1 ngày</b></p>
                        <div class="d-flex justify-content-between">
                            <span>1 tháng x 3.242.432.424 đ</span>
                            <strong>3.242.432.424 đ</strong>
                        </div>
                    </div>

                    <!-- Tiền dịch vụ -->
                    <div class="services-section mt-4">
                        <h6>Tiền dịch vụ</h6>
                        <div class="service-item">
                            <input type="checkbox" checked> Tiền điện
                            <p>Giá: <b>4.000 đ</b> / KWh</p>
                            <input type="number" placeholder="Số cũ"> <input type="number" placeholder="Số mới">
                        </div>
                        <div class="service-item">
                            <input type="checkbox" checked> Tiền nước
                            <p>Giá: <b>20.000 đ</b> / Tháng</p>
                            <input type="number" value="1" placeholder="Tháng">
                        </div>
                        <!-- Các dịch vụ khác ở đây -->
                    </div>

                    <!-- Tổng cộng hóa đơn -->
                    <div class="total-section mt-4">
                        <div class="d-flex justify-content-between">
                            <strong>Tổng cộng hóa đơn</strong>
                            <strong>3.242.517.000 đ</strong>
                        </div>
                    </div>
                </div>

                <!-- Modal Footer -->
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeInvoiceEditModal()">Hủy bỏ</button>
                    <button type="button" class="btn btn-success">Chỉnh sửa hóa đơn</button>
                </div>
            </div>
        </div>
    </div>

    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <script>
        function openPopup() {
            document.getElementById('billingModal').style.display = 'flex';
        }

        function closePopup() {
            document.getElementById('billingModal').style.display = 'none';
        }

        function backPopup() {
            document.getElementById('billingModal').style.display = 'flex';
            document.getElementById('createInvoiceModal').style.display = 'none';
        }


        // Add event listener for the "+" button
        document.querySelector('.add-button-bill').addEventListener('click', openPopup);
        document.querySelector('.back_add_bill').addEventListener('click', backPopup);

        // Close the modal when the close button is clicked
        document.querySelector('.close').addEventListener('click', closePopup);



        function showServiceDetails() {
            document.getElementById('service-details').style.display = 'block';
        }

        function CloseServiceDetails() {
            document.getElementById('service-details').style.display = 'none';
        }

        function showInvoiceEditModal() {
            $('#invoiceEditModal').modal('show');
        }

        function closeInvoiceEditModal() {
            $('#invoiceEditModal').modal('hide');
        }

        let tempInvoiceData = {
            roomId: null,
            services: []
        };

        $(document).ready(function () {
            // When a room is selected
            $(".room-item").on("click", function () {
                const roomId = $(this).data("room-id");
                const settlementDate = $('.settlementdate').val();
                if (tempInvoiceData.roomId && tempInvoiceData.roomId === roomId) {
                    // Nếu đã chọn phòng này rồi thì không làm gì thêm
                    return;
                }
                tempInvoiceData.roomId = roomId;
                $("#RoomId").val(roomId);
                $('#SettlementDate').val(settlementDate);
                // AJAX to fetch room services
                $.ajax({
                    url: '/Bill/GetRoomServices', // Controller endpoint to get services
                    type: 'GET',
                    data: { roomId: roomId },
                    success: function (services) {
                        // Clear existing services
                        $("#services").empty();

                        // Display the fetched services
                        services.forEach((service, index) => {
                            const serviceHtml = `
                <div class="service-item">
                    <input type="checkbox" class="service-checkbox"
                           name="DetailBill[${index}].ServiceId"
                           value="${service.id}" checked>
                    <span>${service.name}</span>
                    <p class="price">Giá: <b>${service.price}</b> / ${service.unit}</p>
                    ${service.unit === "kWh" || service.unit === "m3" ? `
                        <div class="input-group">
                            <input type="number" class="form-control old-value"
                                   name="DetailBill[${index}].OldNumber"
                                           value="${service.OldNumber || 0}"
                                   placeholder="Số cũ">
                            <span class="input-group-text">Số cũ</span>
                        </div>
                        <div class="input-group">
                            <input type="number" class="form-control new-value"
                                   name="DetailBill[${index}].NewNumber"
                                                   value="${service.Number || 0}"
                                   placeholder="Số mới">
                            <span class="input-group-text">Số mới</span>
                        </div>
                    ` : `
                        <div class="input-group">
                            <input type="number" class="form-control quantity"
                                   name="DetailBill[${index}].Number"
                                   placeholder="Số lượng">
                            <span class="input-group-text">Số lượng</span>
                        </div>
                    `}
                </div>`;
                            $("#services").append(serviceHtml);
                        });

                       
                        $("#service-details").show();

                        // Save room data temporarily
                        tempInvoiceData = {
                            roomId: roomId,
                            services: [] // Services will be added after user enters values
                        };
                    },
                    error: function () {
                        alert("Không thể tải dịch vụ.");
                    }
                });
            });

            // Transition to Step 2 (create invoice)
            $(".goToStep2").on("click", function () {
                const settlementDate = $('.settlementdate').val(); // Lấy giá trị ngày chốt
                // Gán ngày chốt vào trường ẩn trong form
                $("#SettlementDate").val(settlementDate);
                tempInvoiceData.services = [];
                let isValid = true;
                // Gather selected services
                $(".service-item").each(function () {
                    const serviceCheckbox = $(this).find('.service-checkbox');  // Tìm checkbox của mỗi dịch vụ
                    //const serviceId = serviceCheckbox.data('service-id');  // Lấy data-service-id từ checkbox
                    const checked = serviceCheckbox.is(":checked");

                    if (checked) {
                        const serviceId = serviceCheckbox.val();
                        const oldValue = $(this).find('.old-value').val();
                        const newValue = $(this).find('.new-value').val();
                        const quantity = $(this).find('.quantity').val();
                        const price = parseFloat($(this).find('.price b').text().trim());


                        const service = {
                            ServiceId:serviceId,
                            Price: price || null,
                            OldNumber: oldValue || null,
                            NewNumber: newValue || null,
                            Number: quantity || null
                        };

                        tempInvoiceData.services.push(service);
                    }
                });
                if (!isValid) {
                    return;
                }

                //$("#services-output").text(JSON.stringify(tempInvoiceData.services, null, 2));
                $("#ServicesData").val(JSON.stringify(tempInvoiceData.services));
                //$("#SettlementDate").val(tempInvoiceData.settlementDate);
                
            });

            $(".create-invoice-btn").on("click", function () {

                const createAt = $('#CreateAt').val();  // Ngày lập hóa đơn (kiểu string từ input)
                const paymentDate = $('#PaymentDate').val(); // Hạn đóng tiền (kiểu string từ input)
                const id_room = $('#RoomId').val();
                const servicesData = $("#ServicesData").val();
                const settlementDate = $('#SettlementDate').val()

                // Chuyển đổi sang định dạng Date nếu cần thiết
                const formattedCreateAt = new Datetime(createAt).toISOString();  // Định dạng ISO 8601
                const formattedPaymentDate = new Date(paymentDate).toISOString();  // Định dạng ISO 8601
                const formattedSettlementDate = new Date(settlementDate).toISOString();
                const services = JSON.parse(servicesData);

                const invoiceData = {
                    RoomId: id_room,  // ID phòng
                    SettlementDate: formattedSettlementDate,
                    CreateAt: formattedCreateAt,  // Ngày lập hóa đơn dưới dạng ISO
                    PaymentDate: formattedPaymentDate,  // Hạn đóng tiền dưới dạng ISO
                    Services: services
                };

                $.ajax({
                    url: '/Bill/CreateInvoice',  // URL action method
                    type: 'POST',
                    //data: invoiceData,  // Gửi dữ liệu trực tiếp từ form
                    contentType: 'application/json',
                    dataType: 'json',
                    data: JSON.stringify(invoiceData),
                    success: function (response) {
                        if (response.success) {
                            alert("Hóa đơn đã được tạo thành công!");
                            $("#createInvoiceModal").modal('hide');  // Đóng modal
                            location.reload();  // Làm mới trang
                        } else {
                            alert("Lỗi: " + response.message);
                        }
                    },
                    error: function (xhr, status, error) {
                        console.error("Lỗi AJAX:", error);
                        alert("Lỗi khi tạo hóa đơn.");
                    }
                });
            });
        });
        $(document).on("input", ".service-item .new-value", function () {
            const serviceItem = $(this).closest(".service-item");
            const oldValue = parseFloat(serviceItem.find(".old-value").val()) || 0;
            const newValue = parseFloat($(this).val()) || 0;

            // Kiểm tra nếu số cuối nhỏ hơn số đầu
            if (newValue < oldValue) {
                $(this).addClass("is-invalid"); // Đánh dấu input không hợp lệ
                serviceItem.find(".error-message").remove(); // Xóa lỗi cũ
                serviceItem.append(`<div class="error-message" style="color: red;">Số mới phải lớn hơn hoặc bằng số cũ!</div>`);
            } else {
                $(this).removeClass("is-invalid"); // Xóa đánh dấu không hợp lệ
                serviceItem.find(".error-message").remove(); // Xóa thông báo lỗi
            }
        });

        function payBill(billId, totalBill ,roomName) {
            totalBill = parseFloat(totalBill);
            // Xác nhận thông tin thanh toán
            if (confirm(`Bạn có chắc chắn muốn thanh toán hóa đơn cho phòng: ${roomName} với tổng tiền: ${totalBill} VND?`)) {
                // Gửi dữ liệu thanh toán lên server
                const data = {
                    BillId: billId,
                    Total: totalBill,
                    RoomName: roomName
                };

                // AJAX gửi dữ liệu lên controller
                $.ajax({
                    url: '/Bill/CreatePaymentUrlVnpay', // Đường dẫn tới action xử lý
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify(data),
                    success: function (response) {
                        if (response.success) {
                            alert("Thanh toán thành công!");
                            window.location.href = response.paymentUrl;
                        } else {
                            alert("Thanh toán thất bại: " + response.message);
                        }
                    },
                    error: function () {
                        alert("Đã xảy ra lỗi khi thanh toán!");
                    }
                });
            }
        }



    </script>

</body>
</html>
